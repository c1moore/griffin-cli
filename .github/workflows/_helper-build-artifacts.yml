name: ZZ-Build Tarball

on:
  workflow_call:
    inputs:
      version:
        type: string
        required: true
      pack-types:
        type: string
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pack-type: ${{ fromJson(inputs.pack-types) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: latest
          cache: npm

      - name: Install Dependencies
        run: |
          npm ci

      - name: Build ${{ matrix.pack-type }}
        run: |
          ./node_modules/.bin/oclif pack ${{ matrix.pack-type }}

      - name: Install 7-Zip
        if: matrix.pack-type == 'tarballs'
        run: |
          apt update
          apt install p7zip-full p7zip-rar

      - name: Install makensis
        if: matrix.pack-type == 'win'
        run: |
          apt update
          apt install nsis

      - name: Upload ${{ matrix.pack-type }} Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.version }}-${{ matrix.pack-type }}
          path: dist/
